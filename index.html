<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="guifeng">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="guifeng">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="guifeng">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/"/>

  <title> guifeng </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">guifeng</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/01/23/ES学习之rest-tcp-层/" itemprop="url">
                  ES学习之rest & tcp 层.md
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-01-23T22:07:13+08:00" content="2018-01-23">
              2018-01-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/learning/" itemprop="url" rel="index">
                    <span itemprop="name">learning</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ES学习之rest-amp-tcp-层"><a href="#ES学习之rest-amp-tcp-层" class="headerlink" title="ES学习之rest &amp; tcp 层"></a>ES学习之rest &amp; tcp 层</h1><p>ElasticSearch之前没有了解过，据说很多公司内部都有大量应用，如Github。作为一名数据工程师，当然也不能只局限于听过，遂打算学习下。最近粗略看了下es部分代码，主要围绕<strong>Search请求</strong>与<strong>Bulk请求</strong>，感觉这样看的效果感觉一般，遂打算写成书面形式，顺便也能练练写文章的能力。上述过程均涉及es的rest和tcp层通信部分，因此本文先分析下这2个知识点，代码基于2.4。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">2.4版本ES通信层的实现主要基于Netty3：</div><div class="line">     a. Rest层核心类： NettyHttpServerTransport，相关代码位于包 org.elasticsearch.http</div><div class="line">     b. TCP层核心类： NettyTransport，相关代码位于包 org.elasticsearch.transport</div></pre></td></tr></table></figure>
<h2 id="Rest-层"><a href="#Rest-层" class="headerlink" title="Rest 层"></a>Rest 层</h2><p>es代码组织很模块化，背后使用了Google依赖注入框架 <a href="https://github.com/google/guice/" title="guice" target="_blank" rel="external">guice</a>。其中，<code>HttpServerModule</code>是es的rest模块，其运用<code>guice</code>相关的<code>configure</code>方法将所有的接口与实现类相关联：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">()</span> </span>&#123;</div><div class="line"> bind(HttpServerTransport.class).to(httpServerTransportClass).asEagerSingleton();</div><div class="line"> bind(HttpServer.class).asEagerSingleton();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>对于上述代码，其将<code>HttpServerTransport</code>接口绑定到实现类<code>NettyHttpServerTransport</code>，并且将<code>HttpServer</code>做成单例。在es的节点启动且开启rest服务时，会启动<code>HttpServer</code>，随后启动<code>HttpServerTransport</code>。</p>
<p><code>Node</code>的启动：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">if</span> (settings.getAsBoolean(<span class="string">"http.enabled"</span>, <span class="keyword">true</span>)) &#123; </div><div class="line">    injector.getInstance(HttpServer.class).start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>HttpServer</code>的启动，其中<code>transport</code>为<code>HttpServerTransport</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doStart</span><span class="params">()</span> </span>&#123;</div><div class="line">      transport.start();</div><div class="line">      <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</div><div class="line">          logger.info(<span class="string">"&#123;&#125;"</span>, transport.boundAddress());</div><div class="line">      &#125;</div><div class="line">      nodeService.putAttribute(<span class="string">"http_address"</span>, transport.boundAddress().publishAddress().toString());</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p><code>HttpServerTransport</code>使用Netty构建rest服务，通过配置Netty的<code>ChannelPipeline</code>来有序地处理请求事件和响应事件。</p>
<blockquote>
<p> 有序添加请求事件的handlers：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">pipeline.addLast(<span class="string">"decoder"</span>, requestDecoder);</div><div class="line">pipeline.addLast(<span class="string">"handler"</span>, requestHandler);</div></pre></td></tr></table></figure>
<p>，请求事件经过decode后，被requestHandler处理，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">messageReceived</span><span class="params">(ChannelHandlerContext ctx, MessageEvent e)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    HttpRequest request;</div><div class="line">    OrderedUpstreamMessageEvent oue = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.httpPipeliningEnabled &amp;&amp; e <span class="keyword">instanceof</span> OrderedUpstreamMessageEvent) &#123;</div><div class="line">        oue = (OrderedUpstreamMessageEvent) e;</div><div class="line">        request = (HttpRequest) oue.getMessage();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        request = (HttpRequest) e.getMessage();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// the netty HTTP handling always copy over the buffer to its own buffer, either in NioWorker internally</span></div><div class="line">    <span class="comment">// when reading, or using a cumalation buffer</span></div><div class="line">    NettyHttpRequest httpRequest = <span class="keyword">new</span> NettyHttpRequest(request, e.getChannel());</div><div class="line">    NettyHttpChannel channel = <span class="keyword">new</span> NettyHttpChannel(serverTransport, httpRequest, oue, detailedErrorsEnabled);</div><div class="line">    serverTransport.dispatchRequest(httpRequest, channel);</div><div class="line">    <span class="keyword">super</span>.messageReceived(ctx, e);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终调用<code>HttpServerTransport</code>的<code>dispatchRequest</code>方法，随后执行<code>HttpServer</code>的<code>internalDispatchRequest</code>，最终调用<code>HttpServer</code>中<code>RestController</code>的<code>dispatchRequest</code>。</p>
<p>至此，我们知道所有rest请求都经过<code>RestController</code>。</p>
<h3 id="RestController"><a href="#RestController" class="headerlink" title="RestController"></a>RestController</h3><p>从<code>RestController</code>代码中可以看出，该类定义了请求方法和资源所对应执行策略。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// RestController 成员变量</span></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> PathTrie&lt;RestHandler&gt; getHandlers = <span class="keyword">new</span> PathTrie&lt;&gt;(RestUtils.REST_DECODER);</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> PathTrie&lt;RestHandler&gt; postHandlers = <span class="keyword">new</span> PathTrie&lt;&gt;(RestUtils.REST_DECODER);</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> PathTrie&lt;RestHandler&gt; putHandlers = <span class="keyword">new</span> PathTrie&lt;&gt;(RestUtils.REST_DECODER);</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> PathTrie&lt;RestHandler&gt; deleteHandlers = <span class="keyword">new</span> PathTrie&lt;&gt;(RestUtils.REST_DECODER);</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> PathTrie&lt;RestHandler&gt; headHandlers = <span class="keyword">new</span> PathTrie&lt;&gt;(RestUtils.REST_DECODER);</div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> PathTrie&lt;RestHandler&gt; optionsHandlers = <span class="keyword">new</span> PathTrie&lt;&gt;(RestUtils.REST_DECODER);</div></pre></td></tr></table></figure>
<p>，这些rest接口(RestXXXXAction)是在<code>RestModule</code>初始化时注册到controller中，且重写<code>handleRequest</code>来构造出transport层的请求，最终由es的<code>org.elasticsearch.client.Client</code>执行响应操作。例如与search接口相对应的<code>RestSearchAction</code>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 注册接口</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">RestSearchAction</span><span class="params">(Settings settings, RestController controller, Client client)</span> </span>&#123;</div><div class="line">      <span class="keyword">super</span>(settings, controller, client);</div><div class="line">      controller.registerHandler(GET, <span class="string">"/_search"</span>, <span class="keyword">this</span>);</div><div class="line">      controller.registerHandler(POST, <span class="string">"/_search"</span>, <span class="keyword">this</span>);</div><div class="line">      controller.registerHandler(GET, <span class="string">"/&#123;index&#125;/_search"</span>, <span class="keyword">this</span>);</div><div class="line">      controller.registerHandler(POST, <span class="string">"/&#123;index&#125;/_search"</span>, <span class="keyword">this</span>);</div><div class="line">      controller.registerHandler(GET, <span class="string">"/&#123;index&#125;/&#123;type&#125;/_search"</span>, <span class="keyword">this</span>);</div><div class="line">      controller.registerHandler(POST, <span class="string">"/&#123;index&#125;/&#123;type&#125;/_search"</span>, <span class="keyword">this</span>);    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerHandler</span><span class="params">(RestRequest.Method method, String path, RestHandler handler)</span> </span>&#123;</div><div class="line">        PathTrie&lt;RestHandler&gt; handlers = getHandlersForMethod(method);</div><div class="line">        <span class="keyword">if</span> (handlers != <span class="keyword">null</span>) &#123;</div><div class="line">            handlers.insert(path, handler);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Can't handle ["</span> + method + <span class="string">"] for path ["</span> + path + <span class="string">"]"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// rest接口重写 handleRequest，实现自己逻辑</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleRequest</span><span class="params">(<span class="keyword">final</span> RestRequest request, <span class="keyword">final</span> RestChannel channel, <span class="keyword">final</span> Client client)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"> SearchRequest searchRequest = <span class="keyword">new</span> SearchRequest();</div><div class="line">    RestSearchAction.parseSearchRequest(searchRequest, request, parseFieldMatcher, <span class="keyword">null</span>);</div><div class="line">    client.search(searchRequest, <span class="keyword">new</span> RestStatusToXContentListener&lt;SearchResponse&gt;(channel)); <span class="comment">// 调用es client的search方法</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="ES-Client"><a href="#ES-Client" class="headerlink" title="ES Client"></a>ES Client</h3><p>对于<code>Client</code>，es提供2种类型<code>Client</code>: <code>NodeClient</code> 和 <code>TransportClient</code>。</p>
<p><code>NodeClient</code>是集群内来创建一种client，只需集群名称，无需提供节点地址。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// NodeClient的创建方式</span></div><div class="line">Node node = nodeBuilder().settings(Settings.settingsBuilder()</div><div class="line">            .put(<span class="string">"http.enabled"</span>, <span class="keyword">false</span>)) </div><div class="line">            .client(<span class="keyword">true</span>)</div><div class="line">            .node();</div><div class="line">Client client = node.client();</div></pre></td></tr></table></figure>
<p><code>TransportClient</code>表示在集群外所创建client，因此需要提供至少一个节点地址作为seed节点来链接集群。当client打开sniff配置（<code>client.transport.sniff = true)</code>, 会定时拉取集群所有节点，并与之建立connection。此外，<code>TransportClient</code>作为集群外创建的客户端，为es请求提供了一种粗粒度的RR负载均衡，见<code>TransportClientNodesService.execute</code>方法。最终<code>Client</code>将相关请求经tcp transport给随机选择的节点上：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(<span class="keyword">final</span> DiscoveryNode node, <span class="keyword">final</span> Request request, <span class="keyword">final</span> ActionListener&lt;Response&gt; listener)</span> </span>&#123;</div><div class="line">        ActionRequestValidationException validationException = request.validate();</div><div class="line">        <span class="keyword">if</span> (validationException != <span class="keyword">null</span>) &#123;</div><div class="line">            listener.onFailure(validationException);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        transportService.sendRequest(node, action.name(), request, transportOptions, <span class="keyword">new</span> ActionListenerResponseHandler&lt;Response&gt;(listener) &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> Response <span class="title">newInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> action.newResponse();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>对于前文举例的<code>RestSearchAction.handleRequest</code>中的client类型是<code>NodeClient</code>。</p>
<h2 id="TCP-层"><a href="#TCP-层" class="headerlink" title="TCP 层"></a>TCP 层</h2><p>前文说道<code>TransportClient</code>已将请求经tcp transport给相关节点，不过在此之前会创建一个<code>requestId</code>，然后将请求实体与相应的<code>requestId</code>打包编码一起发送出去。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// Transport接口，具体详见 NettyTransport 的实现</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendRequest</span><span class="params">(DiscoveryNode node, <span class="keyword">long</span> requestId, String action, TransportRequest request, TransportRequestOptions options)</span> <span class="keyword">throws</span></span></div><div class="line">        IOException, TransportException;</div></pre></td></tr></table></figure>
<p>es的TCP层通信也是使用netty构建，可参考<code>NettyTransport.createServerBootstrap</code>方法，这里和Rest一样，核心需要关注是如何配置<code>ChannelPipeline</code>来有序地处理请求事件和响应事件。</p>
<blockquote>
<p> 有序添加请求事件的handlers：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line">channelPipeline.addLast(<span class="string">"size"</span>, sizeHeader); <span class="comment">// netty的FrameDecoder解码器handler</span></div><div class="line">channelPipeline.addLast(<span class="string">"dispatcher"</span>, <span class="keyword">new</span> MessageChannelHandler(nettyTransport, nettyTransport.logger, name)); <span class="comment">// 请求经解码后handler</span></div></pre></td></tr></table></figure>
<p>这里主要关注下<code>MessageChannelHandler.messageReceived</code>方法，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="keyword">if</span> (TransportStatus.isRequest(status)) &#123; <span class="comment">// 当收到的message是request</span></div><div class="line">        handleRequest(ctx.getChannel(), marker, streamIn, requestId, size, version);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;  <span class="comment">// 当收到的message是response，可以看出response是携带requestId一起返回，这里将请求与响应映射起来了</span></div><div class="line">        TransportResponseHandler&lt;?&gt; handler = transportServiceAdapter.onResponseReceived(requestId);</div><div class="line">        <span class="comment">// ignore if its null, the adapter logs it</span></div><div class="line">        <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (TransportStatus.isError(status)) &#123;</div><div class="line">                handlerResponseError(streamIn, handler);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                handleResponse(ctx.getChannel(), streamIn, handler);</div><div class="line">            &#125;</div><div class="line">            marker.validateResponse(streamIn, requestId, handler, TransportStatus.isError(status));</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>当收到的message是request时，首先将解析请求是哪种<code>action</code>, 然后获取相应的<code>HandledTransportAction</code>抽象类的实现来处理该请求。这些<code>HandledTransportAction</code>实现是在<code>ActionModule</code>中初始化为单例模式，且在初始化时将<code>action</code>与当前实现类在<code>TransportService</code>中映射起来。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// ActionModule configure 方法截取</span></div><div class="line"> <span class="keyword">for</span> (Map.Entry&lt;String, ActionEntry&gt; entry : actions.entrySet()) &#123;</div><div class="line">    <span class="comment">// bind the action as eager singleton, so the map binder one will reuse it</span></div><div class="line">    bind(entry.getValue().transportAction).asEagerSingleton();</div><div class="line">    transportActionsBinder.addBinding(entry.getValue().action).to(entry.getValue().transportAction).asEagerSingleton();</div><div class="line">    <span class="keyword">for</span> (Class supportAction : entry.getValue().supportTransportActions) &#123;</div><div class="line">        bind(supportAction).asEagerSingleton();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><div class="line"><span class="comment">// HandledTransportAction 抽象类的构造方法之一</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">HandledTransportAction</span><span class="params">(Settings settings, String actionName, ThreadPool threadPool, TransportService transportService, ActionFilters actionFilters, IndexNameExpressionResolver indexNameExpressionResolver, Class&lt;Request&gt; request)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(settings, actionName, threadPool, actionFilters, indexNameExpressionResolver, transportService.getTaskManager());</div><div class="line">    transportService.registerRequestHandler(actionName, request, ThreadPool.Names.SAME, <span class="keyword">new</span> TransportHandler()); <span class="comment">// 当`action`与当前实现类在`TransportService`中映射起来</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>，最终请求的执行逻辑走到了<code>TransportXXXXAction</code>类<code>doExecute</code>方法，该方法会返回请求的<code>requestId</code>和处理结果给发送端。</p>
<h2 id="Ending"><a href="#Ending" class="headerlink" title="Ending"></a>Ending</h2><p>这里仅分析了es的Rest层到TCP层的整体逻辑，并未深入分析请求的处理过程，后面再深入分析下<strong>Search</strong>与<strong>Bulk</strong>请求的处理过程。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/04/next/" itemprop="url">
                  next
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-04T23:16:52+08:00" content="2016-09-04">
              2016-09-04
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/09/04/streaming-DevelopApi/" itemprop="url">
                  streaming DevelopApi
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-04T22:50:02+08:00" content="2016-09-04">
              2016-09-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/learning/" itemprop="url" rel="index">
                    <span itemprop="name">learning</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="缘由"><a href="#缘由" class="headerlink" title="缘由"></a>缘由</h2><p> 最近为了获取Spark Streaming的metrics，参考Streaming代码并发现Streaming提供了抽象接口<code>StreamingListener</code>, 以供用户去自定义Listener，当前Streaming已经存在一些Listener，如<code>StreamingJobProgressListener</code>, <code>RateController</code>, <code>StatsReportListener</code>.</p>
<h3 id="StreamingListener接口与应用"><a href="#StreamingListener接口与应用" class="headerlink" title="StreamingListener接口与应用"></a>StreamingListener接口与应用</h3><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Called when a receiver has reported an error */</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">onReceiverError</span></span>(receiverError: <span class="type">StreamingListenerReceiverError</span>) &#123; &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Called when a receiver has been stopped */</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">onReceiverStopped</span></span>(receiverStopped: <span class="type">StreamingListenerReceiverStopped</span>) &#123; &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Called when a batch of jobs has been submitted for processing. */</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">onBatchSubmitted</span></span>(batchSubmitted: <span class="type">StreamingListenerBatchSubmitted</span>) &#123; &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Called when processing of a batch of jobs has started.  */</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">onBatchStarted</span></span>(batchStarted: <span class="type">StreamingListenerBatchStarted</span>) &#123; &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Called when processing of a batch of jobs has completed. */</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">onBatchCompleted</span></span>(batchCompleted: <span class="type">StreamingListenerBatchCompleted</span>) &#123; &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Called when processing of a job of a batch has started. */</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">onOutputOperationStarted</span></span>(</div><div class="line">      outputOperationStarted: <span class="type">StreamingListenerOutputOperationStarted</span>) &#123; &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Called when processing of a job of a batch has completed. */</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">onOutputOperationCompleted</span></span>(</div><div class="line">      outputOperationCompleted: <span class="type">StreamingListenerOutputOperationCompleted</span>) &#123; &#125;</div></pre></td></tr></table></figure>
<p>如上所见，<code>StreamingListener</code> trait提供了各种接口，其中利用<code>onBatchCompleted</code>可实现在每个batch执行结束之后kafka offset的保存，而不是在Streaming每个batch未执行之前就存储offset; 除此以外，综合利用这些接口可以获取Spark UI上各种metrics, 从而不需要使用Spark自带的Metrics系统（<code>Source</code>）实现metrics获取，并且自己实现具有很大的灵活性（需要注意操作阻塞问题，最好在函数内部异步执行较重的操作）。</p>
<ul>
<li><p>附: Spark Streaming其他的DeveloperApi</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"> $ grep -n <span class="string">":: DeveloperApi ::"</span> src</div><div class="line">src/main/java/org/apache/spark/streaming/<span class="type">StreamingContextState</span>.java:<span class="number">23</span>: * :: <span class="type">DeveloperApi</span> ::</div><div class="line">src/main/java/org/apache/spark/streaming/util/<span class="type">WriteAheadLog</span>.java:<span class="number">24</span>: * :: <span class="type">DeveloperApi</span> ::</div><div class="line">src/main/java/org/apache/spark/streaming/util/<span class="type">WriteAheadLogRecordHandle</span>.java:<span class="number">21</span>: * :: <span class="type">DeveloperApi</span> ::</div><div class="line">src/main/scala/org/apache/spark/streaming/api/java/<span class="type">JavaStreamingContext</span>.scala:<span class="number">599</span>:   * :: <span class="type">DeveloperApi</span> ::</div><div class="line">src/main/scala/org/apache/spark/streaming/receiver/<span class="type">ActorReceiver</span>.scala:<span class="number">35</span>: * :: <span class="type">DeveloperApi</span> ::</div><div class="line">src/main/scala/org/apache/spark/streaming/receiver/<span class="type">ActorReceiver</span>.scala:<span class="number">49</span>: * :: <span class="type">DeveloperApi</span> ::</div><div class="line">src/main/scala/org/apache/spark/streaming/receiver/<span class="type">ActorReceiver</span>.scala:<span class="number">104</span>: * :: <span class="type">DeveloperApi</span> ::</div><div class="line">src/main/scala/org/apache/spark/streaming/receiver/<span class="type">Receiver</span>.scala:<span class="number">29</span>: * :: <span class="type">DeveloperApi</span> ::</div><div class="line">src/main/scala/org/apache/spark/streaming/scheduler/<span class="type">BatchInfo</span>.scala:<span class="number">24</span>: * :: <span class="type">DeveloperApi</span> ::</div><div class="line">src/main/scala/org/apache/spark/streaming/scheduler/<span class="type">InputInfoTracker</span>.scala:<span class="number">27</span>: * :: <span class="type">DeveloperApi</span> ::</div><div class="line">src/main/scala/org/apache/spark/streaming/scheduler/<span class="type">OutputOperationInfo</span>.scala:<span class="number">24</span>: * :: <span class="type">DeveloperApi</span> ::</div><div class="line">src/main/scala/org/apache/spark/streaming/scheduler/<span class="type">ReceiverInfo</span>.scala:<span class="number">24</span>: * :: <span class="type">DeveloperApi</span> ::</div><div class="line">src/main/scala/org/apache/spark/streaming/scheduler/<span class="type">StreamingListener</span>.scala:<span class="number">26</span>: * :: <span class="type">DeveloperApi</span> ::</div><div class="line">src/main/scala/org/apache/spark/streaming/scheduler/<span class="type">StreamingListener</span>.scala:<span class="number">62</span>: * :: <span class="type">DeveloperApi</span> ::</div><div class="line">src/main/scala/org/apache/spark/streaming/scheduler/<span class="type">StreamingListener</span>.scala:<span class="number">98</span>: * :: <span class="type">DeveloperApi</span> ::</div><div class="line">src/main/scala/org/apache/spark/streaming/<span class="type">StreamingContext</span>.scala:<span class="number">574</span>:   * :: <span class="type">DeveloperApi</span> ::</div></pre></td></tr></table></figure>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/30/kafkaController机制/" itemprop="url">
                  kafkaController机制
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-30T09:26:28+08:00" content="2016-07-30">
              2016-07-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/learning/" itemprop="url" rel="index">
                    <span itemprop="name">learning</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<h1 id="前记"><a href="#前记" class="headerlink" title="前记"></a>前记</h1><blockquote>
<p>&emsp;&emsp;&emsp;&emsp;昨天线上kafka集群频繁出现controller选举，主要原因是zookeeper的/brokers/topics中存在2个topic元信息为null(原因暂未知)，使得json解析失败，最终导致controller选举一直处于失败状态。kafka官方jira上有个issue与上述情况很类似<a href="https://issues.apache.org/jira/browse/KAFKA-799" title="KAFKA-799" target="_blank" rel="external">KAFKA-799</a>，最终解决办法是删除ZK上这2个topic节点。</p>
</blockquote>
<hr>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><hr>
<p><code>未完待续....</code></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/27/thanks/" itemprop="url">
                  Thanks oplinjie
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-27T22:15:00+08:00" content="2016-07-27">
              2016-07-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/life/" itemprop="url" rel="index">
                    <span itemprop="name">life</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p> Thanks Linjie~</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://img5.imgtn.bdimg.com/it/u=2874763218,1653340119&fm=21&gp=0.jpg"
               alt="guifeng" />
          <p class="site-author-name" itemprop="name">guifeng</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">5</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/gf53520" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/2765853894" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  Sun Jul 24 2016 08:00:00 GMT+0800 (CST) - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">guifeng</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  

</body>
</html>
